var at,socks=[],sockData=["","","","",""],MAXSOCKETS=5,ENCR_FLAGS=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"];let mdnsAdr,mdnsPrt;function udpToIPAndPort(data){return{ip:data.charCodeAt(0)+"."+data.charCodeAt(1)+"."+data.charCodeAt(2)+"."+data.charCodeAt(3),port:data.charCodeAt(5)<<8|data.charCodeAt(4),len:data.charCodeAt(7)<<8|data.charCodeAt(6)}}var netCallbacks={create:function(host,port,type){if(2==type){let sckt=0;for(;void 0!==socks[sckt];)sckt++;if(sckt>=MAXSOCKETS)return-7;sockData[sckt]="";let cmd=`AT+CIPSTART=${sckt},"UDP","${mdnsAdr}",${mdnsPrt},${mdnsPrt},2\r\n`;socks[sckt]="UDP",sockUDP[sckt]=!0,at.cmd(cmd,1e4,(function cb(d){if("ALREADY CONNECTED"==d)return cb;"OK"!=d&&(socks[sckt]=-6)}))}else{var sckt,self=this;if(void 0===host)return socks[sckt=MAXSOCKETS]="Wait",sockData[sckt]="",at.cmd("AT+CIPSERVER=1,"+port+"\r\n",1e4,(function(d){"OK"===d?socks[sckt]=!0:(socks[sckt]=void 0,self.emit("err","CIPSERVER failed ("+(d||"Timeout")+")"))})),MAXSOCKETS;for(sckt=0;void 0!==socks[sckt];)sckt++;if(sckt>=MAXSOCKETS)return self.emit("err","No free sockets"),null;socks[sckt]="Wait",sockData[sckt]="",at.cmd("AT+CIPSTART="+sckt+',"TCP",'+JSON.stringify(host)+","+port+"\r\n",1e4,(function cb(d){if(d===sckt+",CONNECT")return socks[sckt]=!0,cb;"OK"===d?at.registerLine(sckt+",CLOSED",(function(){at.unregisterLine(sckt+",CLOSED"),socks[sckt]=void 0})):(socks[sckt]=void 0,self.emit("err","CIPSTART failed ("+(d||"Timeout")+")"))}))}return console.log(socks[sckt]),sckt},close:function(sckt){"Wait"===socks[sckt]?socks[sckt]="WaitClose":void 0!==socks[sckt]&&at.cmd((sckt===MAXSOCKETS?"AT+CIPSERVER=0":"AT+CIPCLOSE="+sckt)+"\r\n",1e3,(function(){socks[sckt]=void 0}))},accept:function(){for(var i=0;i<MAXSOCKETS;i++)if(sockData[i]&&void 0===socks[i])return socks[i]=!0,i;return-1},recv:function(sckt,maxLen){var r;return console.log("Recv",socks[sckt]),sockData[sckt]?(sockData[sckt].length>maxLen?(r=sockData[sckt].substr(0,maxLen),sockData[sckt]=sockData[sckt].substr(maxLen)):(r=sockData[sckt],sockData[sckt]="","DataClose"==socks[sckt]&&(socks[sckt]=void 0)),r):socks[sckt]<0?socks[sckt]:socks[sckt]?"":-1},send:function(sckt,data){if("UDP"===socks[sckt]){let d=udpToIPAndPort(data),extra=',"'+d.ip+'",'+d.port;data=data.substr(8,d.len);let returnVal=8+d.len;return console.log(d),at.cmd(`AT+CIPSEND=${sckt},${data.length+extra}\r\n`,2e3,(function cb(d){if("OK"==d)at.register("> ",(function(l){return at.unregister("> "),at.write(data),l.substr(2)}));else{if(d!="Recv "+data.length+" bytes"&&"busy s..."!=d)return"SEND OK"==d?("WaitClose"==socks[sckt]&&netCallbacks.close(sckt),console.log(d),void(socks[sckt]=!0)):(console.log(d),socks[sckt]=void 0,void at.unregister("> "));console.log(d)}return cb})),socks[sckt]="Wait",returnVal}if(at.isBusy()||"Wait"===socks[sckt])return 0;if(!socks[sckt])return-1;var cmd="AT+CIPSEND="+sckt+","+data.length+"\r\n";return at.cmd(cmd,1e4,(function cb(d){return"OK"===d?(at.register("> ",(function(){return at.unregister("> "),at.write(data),""})),cb):d==="Recv "+data.length+" bytes"?cb:void("SEND OK"===d?("WaitClose"===socks[sckt]&&netCallbacks.close(sckt),socks[sckt]=!0):(socks[sckt]=void 0,at.unregister("> ")))})),socks[sckt]="Wait",data.length}};function ipdHandler(line){console.log("Handler called");var colon=line.indexOf(":");if(colon<0)return line;var parms=line.substring(5,colon).split(",");parms[1]=0|parms[1];var len=line.length-(colon+1),sckt=parms[0];if(sockUDP[sckt]){var ip=(parms[2]||"0.0.0.0").split(".").map((function(x){return 0|x})),p=0|parms[3];sockData[sckt]+=String.fromCharCode(ip[0],ip[1],ip[2],ip[3],255&p,p>>8,255&len,len>>8)}return len>=parms[1]?(sockData[parms[0]]+=line.substr(colon+1,parms[1]),line.substr(colon+parms[1]+1)):(sockData[sckt]+=line.substr(colon+1,len),at.getData(parms[1]-len,(function(data){sockData[sckt]+=data})),"")}function sckOpen(ln){var sckt=ln[0];void 0===socks[sckt]&&socks[MAXSOCKETS]?socks[sckt]="Accept":"Wait"==socks[sckt]?socks[sckt]=!0:at.cmd("AT+CIPCLOSE="+sckt+"\r\n",1e3,(function(){socks[sckt]=void 0}))}function sckClosed(ln){socks[ln[0]]=""!=sockData[ln[0]]?"DataClose":void 0}var ESP8266={ipdHandler:ipdHandler,debug:function(){return{socks:socks,sockData:sockData}},init:function(callback){at.cmd("ATE0\r\n",1e3,(function cb(d){if("ATE0"===d)return cb;"OK"===d?at.cmd("AT+CIPMUX=1\r\n",1e3,(function(d){callback("OK"!==d?"CIPMUX failed: "+(d||"Timeout"):null)})):callback("ATE0 failed: "+(d||"Timeout"))}))},reset:function(callback){at.cmd("\r\nAT+RST\r\n",1e4,(function cb(d){if("ready"===d||"Ready."===d)setTimeout((function(){ESP8266.init(callback)}),1e3);else if("jump to run user1 @ 1000"===d)setTimeout((function(){ESP8266.init(callback)}),5e3);else{if(void 0!==d)return cb;callback('No "ready" after AT+RST')}}))},getVersion:function(callback){at.cmd("AT+GMR\r\n",1e3,(function(d){callback(null,d)}))},connect:function(ssid,key,callback){at.cmd("AT+CWMODE=1\r\n",1e3,(function(cwm){"no change"!==cwm&&"OK"!==cwm?callback("CWMODE failed: "+(cwm||"Timeout")):at.cmd("AT+CWJAP="+JSON.stringify(ssid)+","+JSON.stringify(key)+"\r\n",2e4,(function cb(d){if(["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(d)>=0)return cb;"OK"!==d?setTimeout(callback,0,"WiFi connect failed: "+(d||"Timeout")):setTimeout(callback,0,null)}))}))},getAPs:function(callback){var aps=[];at.cmdReg("AT+CWLAP\r\n",5e3,"+CWLAP:",(function(d){var ap=d.slice(8,-1).split(",");aps.push({ssid:JSON.parse(ap[1]),enc:ENCR_FLAGS[ap[0]],signal:parseInt(ap[2]),mac:JSON.parse(ap[3])})}),(function(){callback(null,aps)}))},getConnectedAP:function(callback){var con;at.cmdReg("AT+CWJAP?\r\n",1e3,"+CWJAP:",(function(d){con=JSON.parse(d.slice(7))}),(function(){callback(null,con)}))},createAP:function(ssid,key,channel,enc,callback){at.cmd("AT+CWMODE=2\r\n",1e3,(function(cwm){"no change"!==cwm&&"OK"!==cwm&&"WIFI DISCONNECT"!==cwm&&callback("CWMODE failed: "+(cwm||"Timeout"));var encn=enc?ENCR_FLAGS.indexOf(enc):0;encn<0?callback("Encryption type "+enc+" not known - "+ENCR_FLAGS):at.cmd("AT+CWSAP="+JSON.stringify(ssid)+","+JSON.stringify(key)+","+channel+","+encn+"\r\n",5e3,(function(cwm){callback("OK"!==cwm?"CWSAP failed: "+(cwm||"Timeout"):null)}))}))},getConnectedDevices:function(callback){var devs=[];this.at.cmd("AT+CWLIF\r\n",1e3,(function r(d){if("OK"===d)callback(null,devs);else{if(void 0!==d&&"ERROR"!==d){var e=d.split(",");return devs.push({ip:e[0],mac:e[1]}),r}callback("Error")}}))},getIP:function(callback){var ip;at.cmdReg("AT+CIFSR\r\n",1e3,"+CIFSR",(function(d){!ip&&d.indexOf(",")>=0&&(ip=JSON.parse(d.slice(d.indexOf(",")+1)))}),(function(d){"OK"!==d?callback("CIFSR failed: "+d):callback(null,ip)}))},setIP:function(settings,callback){var cmd,timeout;if("object"==typeof settings&&settings.ip){var args=[JSON.stringify(settings.ip)];settings.gw&&(args.push(JSON.stringify(settings.gw)),args.push(JSON.stringify(settings.netmask||"255.255.255.0"))),cmd="AT+CIPSTA_CUR="+args.join(",")+"\r\n",timeout=3e3}else cmd="AT+CWDHCP_CUR=1,1\r\n",timeout=2e4;at.cmd(cmd,timeout,(function(d){if("OK"!=d)return callback("setIP failed: "+(d||"Timeout"));callback(null)}))},setMDNS:function(hostname,serviceType,port,callback){at.cmd('AT+MDNS=1,"'+hostname+'","'+serviceType+'",'+port+"\r\n",500,(function(d){callback("OK"==d?null:d)}))},setSNTP:function(hostname,port){mdnsAdr=hostname,mdnsPrt=port}};exports.setup=function(usart,connectedCallback){return"function"==typeof usart&&(connectedCallback=usart,(usart=PrimarySerial).setup(115200)),ESP8266.at=at=require("AT").connect(usart),require("NetworkJS").create(netCallbacks),netCallbacks.on("err",(function(e){ESP8266.emit("err",e)})),at.register("+IPD",ipdHandler),at.registerLine("0,CONNECT",sckOpen),at.registerLine("1,CONNECT",sckOpen),at.registerLine("2,CONNECT",sckOpen),at.registerLine("3,CONNECT",sckOpen),at.registerLine("4,CONNECT",sckOpen),at.registerLine("0,CLOSED",sckClosed),at.registerLine("1,CLOSED",sckClosed),at.registerLine("2,CLOSED",sckClosed),at.registerLine("3,CLOSED",sckClosed),at.registerLine("4,CLOSED",sckClosed),ESP8266.reset(connectedCallback),ESP8266};